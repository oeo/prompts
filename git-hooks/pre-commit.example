#!/bin/sh

# validate gpg setup
node bin/validate-encryption-setup.js
if [ $? -ne 0 ]; then
  echo "error: gpg setup validation failed"
  exit 1
fi

# create encrypted archive
node bin/create-encrypted-archive.js
if [ $? -ne 0 ]; then
  echo "error: failed to create encrypted archive"
  exit 1
fi

# check if we have any untracked archives
if [ -n "$(git ls-files --others --exclude-standard .archives/)" ]; then
  # stage and amend the commit with the new archive
  git add .archives/*.tar.gpg
  git commit --amend --no-edit
fi

exit 0 